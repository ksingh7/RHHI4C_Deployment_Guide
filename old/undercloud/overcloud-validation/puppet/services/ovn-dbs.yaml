heat_template_version: pike

description: >
  OVN databases configured with puppet

parameters:
  ServiceData:
    default: {}
    description: Dictionary packing service data
    type: json
  ServiceNetMap:
    default: {}
    description: Mapping of service_name -> network name. Typically set
                 via parameter_defaults in the resource registry.  This
                 mapping overrides those in ServiceNetMapDefaults.
    type: json
  DefaultPasswords:
    default: {}
    type: json
  RoleName:
    default: ''
    description: Role name on which the service is applied
    type: string
  RoleParameters:
    default: {}
    description: Parameters specific to the role
    type: json
  EndpointMap:
    default: {}
    description: Mapping of service endpoint -> protocol. Typically set
                 via parameter_defaults in the resource registry.
    type: json
  OVNNorthboundServerPort:
    description: Port of the OVN Northbound DB server
    type: number
    default: 6641
  OVNSouthboundServerPort:
    description: Port of the OVN Southbound DB server
    type: number
    default: 6642

outputs:
  role_data:
    description: Role data for the OVN northd service
    value:
      service_name: ovn_dbs
      config_settings:
          ovn::northbound::port: {get_param: OVNNorthboundServerPort}
          ovn::southbound::port: {get_param: OVNSouthboundServerPort}
          ovn::northd::dbs_listen_ip: {get_param: [ServiceNetMap, OvnDbsNetwork]}
          tripleo::haproxy::ovn_dbs_manage_lb: true
          tripleo.ovn_dbs.firewall_rules:
            '121 OVN DB server ports':
              proto: 'tcp'
              dport:
                - {get_param: OVNNorthboundServerPort}
                - {get_param: OVNSouthboundServerPort}
      step_config: |
        include ::tripleo::profile::base::neutron::ovn_northd
      upgrade_tasks:
        - name: Check if ovn_northd is deployed
          command: systemctl is-enabled ovn-northd
          tags: common
          ignore_errors: True
          register: ovn_northd_enabled
        - name: "PreUpgrade step0,validation: Check service ovn-northd is running"
          shell: /usr/bin/systemctl show 'ovn-northd' --property ActiveState | grep '\bactive\b'
          when: ovn_northd_enabled.rc == 0
          tags: step0,validation
        - name: Stop ovn-northd service
          tags: step1
          when: ovn_northd_enabled.rc == 0
          service: name=ovn-northd state=stopped
